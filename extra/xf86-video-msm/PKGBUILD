plugrel=1
noautobuild=1

# Still doesn't build cleanly into a non /usr/local/...directory.

pkgname=xf86-video-msm
pkgver=20111218
pkgrel=1
pkgdesc="XF86 Video Drivers for MSM"
arch=('armv7h')
url="http://www.quicinc.com/"
license=('GPL')
depends=('xorg-server')
makedepends=('git' 'xorg-server-devel' 'xproto' 'glproto' 'xf86driproto')
source=('am-patch.patch' 'try-me.patch' 'no-neon-aligncopy.patch' 
'no-neon-mdp.patch')
md5sums=(8b80c9611272070f20573dbceaeb3a9d
         36b8108d24eb8bf1e3cb865c1d9c278a
         c24f5567e6d808b34e0ed721ab9018de
         3b58e2f23e7576a511c4834b586e8f58)
_gitroot="git://codeaurora.org/quic/xwin/xf86-video-msm.git"
_gitname="xf86-video-msm"

build() {
  cd $srcdir

 ## Git checkout
  msg "Git checkout:  Retrieving sources"
  rm -rf ${_gitname}
  git clone ${_gitroot}
  cd ${_gitname} && git checkout remotes/origin/chromium
  msg "Checkout completed"

  cd $srcdir/${_gitname}
  mkdir output
  ./autogen.sh

  # Symlink to the kernel headers from 2.6.35-palm-tenderloin
  ln -s /usr/src/linux-2.6.35/linux/ linux
  ln -s /usr/src/linux-2.6.35/drm/ drm

  # PATCH: Turn off neon optimizations
  cp $srcdir/am-patch.patch $srcdir/xf86-video-msm/
  patch -p1 < am-patch.patch

  ./autogen.sh
  cp $srcdir/try-me.patch $srcdir/xf86-video-msm/src/
  cd $srcdir/xf86-video-msm/src/ && patch -p1 < try-me.patch
  cd ..

  patch -p1 < $srcdir/no-neon-aligncopy.patch
  patch -p1 < $srcdir/no-neon-mdp.patch

  libdir=output make
  prefix=output make install #FIXME: Find out how to install to $pkgdir
}

package() { 
  cd $srcdir/${_gitname}/output/

  # create directory structure
  install -d $pkgdir/usr/lib/xorg/modules/drivers

  # copy everything
  cp -a * $pkgdir/usr/lib/xorg/modules/drivers/
}
