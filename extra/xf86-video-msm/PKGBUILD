plugrel=1
noautobuild=1

pkgname=xf86-video-msm
pkgver=20111217
pkgrel=1
pkgdesc="XF86 Video Drivers for MSM"
arch=('arm')
url="http://www.quicinc.com/"
license=('GPL')
depends=('xorg-server')
makedepends=('git' 'xorg-server-devel' 'xproto' 'glproto' 'xf86driproto')

_gitroot="git://codeaurora.org/quic/xwin/xf86-video-msm.git"
_gitname="xf86-video-msm"

build() {
  cd $srcdir

 ## Git checkout
  if [ -d $srcdir/${_gitname} ] ; then
    msg "Git checkout:  Updating existing tree"
    cd ${_gitname} && git pull
    msg "Git checkout:  Tree has been updated"
  else
    msg "Git checkout:  Retrieving sources"
    git clone ${_gitroot}  
    git checkout remotes/origin/chromium
  fi
  msg "Checkout completed"

  cd $srcdir/${_gitname}
  mkdir output
  ./autogen.sh

  # PATCH: Turn off neon optimizations
  patch -p1 < $srcdir/no-neon.patch

  # Symlink to the kernel headers from 2.6.35-palm-tenderloin
  ln -s /usr/src/linux/2.6.35/linux linux
  ln -s /usr/src/linux/2.6.35/drm drm

  make
  prefix=output make install #FIXME: Find out how to install to $pkgdir
}

package() { 
  cd $srcdir/${_gitname}/output/

  # create directory structure
  install -d $pkgdir/usr/lib/xorg/modules/drivers

  # copy everything
  cp -a * $pkgdir/usr/lib/xorg/modules/drivers/
}
